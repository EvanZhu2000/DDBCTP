# 系统架构文档 (System Architecture)

## 总体架构

### 架构概览

综合交易框架采用分层架构设计，实现了策略执行分离、复杂订单管理和实时风险控制。系统基于DolphinDB流计算引擎，提供高性能、低延迟的量化交易解决方案。

```
┌─────────────────────────────────────────────────────────────────┐
│                        应用层 (Application Layer)                │
├─────────────────────────────────────────────────────────────────┤
│  Web监控界面  │  策略管理  │  风险监控  │  报表分析  │  告警系统  │
└─────────────────────────────────────────────────────────────────┘
                                    │
┌─────────────────────────────────────────────────────────────────┐
│                        业务层 (Business Layer)                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │  策略工厂   │  │  订单管理   │  │  风险控制   │              │
│  │ Strategy    │  │   Order     │  │    Risk     │              │
│  │ Factory     │  │ Management  │  │ Management  │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                                    │
┌─────────────────────────────────────────────────────────────────┐
│                        计算层 (Computing Layer)                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │  因子计算   │  │  信号生成   │  │  执行引擎   │              │
│  │   Factor    │  │   Signal    │  │ Execution   │              │
│  │Calculation  │  │ Generation  │  │   Engine    │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│                                                                 │
│              DolphinDB 流计算引擎 (Stream Engine)                │
└─────────────────────────────────────────────────────────────────┘
                                    │
┌─────────────────────────────────────────────────────────────────┐
│                        数据层 (Data Layer)                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │  市场数据   │  │  交易数据   │  │  持仓数据   │              │
│  │ Market Data │  │ Trade Data  │  │ Position    │              │
│  │   (CTP)     │  │             │  │    Data     │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│                                                                 │
│              DolphinDB 分布式数据库 (Database)                   │
└─────────────────────────────────────────────────────────────────┘
```

## 核心组件架构

### 1. 策略执行分离架构

#### 传统架构问题
```
传统架构：策略计算 + 执行逻辑耦合
┌─────────────────┐
│   策略函数      │ ──┐
│ ┌─────────────┐ │   │
│ │ 因子计算    │ │   │ 紧耦合
│ │ 信号生成    │ │   │
│ │ 执行决策    │ │   │
│ └─────────────┘ │ ──┘
└─────────────────┘
```

#### 分离架构设计
```
分离架构：策略计算 与 执行逻辑分离
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   因子计算层    │───▶│   策略信号层    │───▶│   执行决策层    │
│ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │
│ │ 技术指标    │ │    │ │ 信号生成    │ │    │ │ 持仓管理    │ │
│ │ 基本面因子  │ │    │ │ 信号过滤    │ │    │ │ 订单生成    │ │
│ │ 宏观因子    │ │    │ │ 信号组合    │ │    │ │ 风险控制    │ │
│ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │
└─────────────────┘    └─────────────────┘    └─────────────────┘
        │                       │                       │
        ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ factor_stream   │    │ signal_stream   │    │ order_stream    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 2. 流计算架构

#### 数据流向图
```
Market Data ──┐
              │
              ▼
         ┌─────────┐
         │tickStream│
         └─────────┘
              │
              ▼
    ┌─────────────────┐
    │ Time Series     │
    │ Aggregation     │
    │ Engines         │
    └─────────────────┘
              │
         ┌────┴────┐
         ▼         ▼
    ┌─────────┐ ┌─────────┐
    │agg1min  │ │agg5min  │
    └─────────┘ └─────────┘
         │         │
         ▼         ▼
    ┌─────────────────┐
    │ Reactive State  │
    │ Engines         │
    │ (Factor Calc)   │
    └─────────────────┘
              │
              ▼
    ┌─────────────────┐
    │ factor_stream   │
    └─────────────────┘
              │
              ▼
    ┌─────────────────┐
    │ Strategy        │
    │ Execution       │
    │ Engine          │
    └─────────────────┘
              │
              ▼
    ┌─────────────────┐
    │ order_stream    │
    └─────────────────┘
```

### 3. 订单管理架构

#### 订单生命周期
```
订单创建 ──┐
          │
          ▼
    ┌─────────────┐
    │ 风险检查    │
    └─────────────┘
          │
          ▼
    ┌─────────────┐
    │ 订单队列    │
    └─────────────┘
          │
          ▼
    ┌─────────────┐
    │ 订单发送    │
    └─────────────┘
          │
          ▼
    ┌─────────────┐
    │ 状态跟踪    │
    └─────────────┘
          │
     ┌────┴────┐
     ▼         ▼
┌─────────┐ ┌─────────┐
│ 成交    │ │ 撤单    │
│ 处理    │ │ 重发    │
└─────────┘ └─────────┘
```

#### 复杂订单管理组件
```
┌─────────────────────────────────────────────────────────────────┐
│                    订单管理系统 (Order Management)               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ 订单跟踪器  │  │ 风险管理器  │  │ 队列管理器  │              │
│  │Order Tracker│  │Risk Manager │  │Queue Manager│              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│         │                 │                 │                  │
│         ▼                 ▼                 ▼                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ 状态监控    │  │ 实时检查    │  │ 时序处理    │              │
│  │ 价格跟踪    │  │ 限额控制    │  │ 批量处理    │              │
│  │ 时间监控    │  │ 频率控制    │  │ 优先级队列  │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                    处理线程 (Processing Threads)                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ 撤单重发    │  │ 部分成交    │  │ 失败重试    │              │
│  │ 处理线程    │  │ 处理线程    │  │ 处理线程    │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 数据模型设计

### 1. 流表结构

#### 基础数据流表
```sql
-- Tick数据流
tickStream: symbol, timestamp, price, volume

-- 聚合数据流
agg1min: timestamp, symbol, price
agg5min: timestamp, symbol, price
agg15min: timestamp, symbol, price

-- 因子数据流
factor_stream: symbol, timestamp, price, factor_type, factor_value, signal_type, signal_value

-- 策略专用流表
bollinger_stream: symbol, timestamp, price, bb_upper, bb_middle, bb_lower, long_signal, short_signal, close_signal
```

#### 交易相关流表
```sql
-- 订单流
orderStream: orderID, symbol, timestamp, orderPrice, orderVolume, direction

-- 成交流
trades: symbol, timestamp, price, qty, dir, offset, exchange

-- 委托回报流
positions_orders: orderid, timestamp, symbol, exchange, direction, offset, status, volume, traded

-- 撤单重发流
cancel_reorder_stream: orderid, action, new_price, symbol, reason
```

### 2. 键值表结构

#### 持仓管理表
```sql
-- 持仓汇总表
positionTable: [symbol, dir] -> symbol, qty, price, dir

-- 订单状态表
orders: [orderid] -> orderid, symbol, timestamp, price, vol, dir, offset, status, type

-- 持仓详情表
positionholding: [symbol] -> timestamp, symbol, long_pos, long_yd, long_td, short_pos, short_yd, short_td, ...
```

### 3. 数据关系图

```
tickStream ──┬──▶ agg1min ──▶ bollinger_stream ──▶ orderStream
             │
             ├──▶ agg5min ──▶ cross_section_table
             │
             └──▶ agg15min ──▶ trend_analysis_stream

orderStream ──▶ CTP Gateway ──▶ positions_orders ──┬──▶ orders (update)
                                                    │
                                                    └──▶ positionholding (update)

CTP Gateway ──▶ trades ──┬──▶ positionTable (update)
                         │
                         ├──▶ realized_positions
                         │
                         └──▶ partial_fill_tracking

tickStream + positionTable ──▶ unrealized_positions
```

## 性能架构

### 1. 计算性能优化

#### 流计算引擎优化
```
┌─────────────────────────────────────────────────────────────────┐
│                    DolphinDB 流计算优化                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ 时间序列    │  │ 响应式状态  │  │ 查找连接    │              │
│  │ 聚合引擎    │  │ 计算引擎    │  │ 引擎        │              │
│  │TimeSeriesEng│  │ReactiveState│  │LookupJoin   │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│         │                 │                 │                  │
│         ▼                 ▼                 ▼                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ 窗口聚合    │  │ 增量计算    │  │ 实时关联    │              │
│  │ 滑动窗口    │  │ 状态维护    │  │ 快速查找    │              │
│  │ 批量处理    │  │ 事件驱动    │  │ 内存优化    │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 内存管理策略
```python
# 流表大小配置
STREAM_TABLE_CONFIG = {
    "tickStream": {"capacity": 100000, "retention": "1d"},
    "agg1min": {"capacity": 10000, "retention": "7d"},
    "orderStream": {"capacity": 50000, "retention": "1d"},
    "trades": {"capacity": 50000, "retention": "30d"}
}

# 内存清理策略
MEMORY_CLEANUP = {
    "auto_cleanup": True,
    "cleanup_interval": 3600,  # 1小时
    "retention_policy": "time_based"
}
```

### 2. 网络架构

#### 连接管理
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Trading App   │◀──▶│   DolphinDB     │◀──▶│   Data Source   │
│                 │    │   Cluster       │    │   (CTP/Other)   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ Connection Pool │    │ Stream Engine   │    │ Market Data     │
│ - 主连接        │    │ - 计算节点      │    │ - 行情推送      │
│ - 备用连接      │    │ - 存储节点      │    │ - 交易接口      │
│ - 健康检查      │    │ - 控制节点      │    │ - 状态监控      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 3. 延迟优化

#### 关键路径优化
```
Market Data ──▶ DolphinDB ──▶ Strategy ──▶ Order ──▶ CTP
    <1ms           <5ms        <10ms      <5ms      <20ms
                                                      
总延迟目标: <50ms (从市场数据到订单发送)
```

#### 优化策略
1. **数据路径优化**: 减少数据拷贝和序列化
2. **计算优化**: 使用向量化计算和并行处理
3. **网络优化**: 连接复用和批量传输
4. **内存优化**: 预分配内存和对象池

## 扩展性架构

### 1. 水平扩展

#### 多节点部署
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Controller    │    │   Data Node 1   │    │   Data Node 2   │
│   (Master)      │◀──▶│   (Compute)     │◀──▶│   (Compute)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ 元数据管理      │    │ 流计算处理      │    │ 流计算处理      │
│ 任务调度        │    │ 数据存储        │    │ 数据存储        │
│ 负载均衡        │    │ 本地计算        │    │ 本地计算        │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 2. 垂直扩展

#### 组件分离部署
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ Strategy Server │    │ Order Server    │    │ Risk Server     │
│ - 策略计算      │    │ - 订单管理      │    │ - 风险控制      │
│ - 信号生成      │    │ - 执行管理      │    │ - 限额检查      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │ Message Queue   │
                    │ (Redis/RabbitMQ)│
                    └─────────────────┘
```

## 安全架构

### 1. 网络安全
- VPN接入控制
- 防火墙规则配置
- SSL/TLS加密传输
- API访问控制

### 2. 数据安全
- 敏感数据加密存储
- 访问权限控制
- 操作日志审计
- 数据备份策略

### 3. 应用安全
- 身份认证机制
- 权限分级管理
- 代码安全审计
- 运行时保护

这个架构文档详细描述了系统的各个层次和组件，为开发和运维提供了清晰的技术指导。
